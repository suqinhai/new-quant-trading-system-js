# =============================================================================
# Docker Compose - 单策略部署配置 (使用宿主机Redis/ClickHouse)
# Single-Strategy Deployment Configuration (Using Host Redis/ClickHouse)
#
# 运行单个策略实例，适合测试或小规模部署
# Run a single strategy instance, suitable for testing or small-scale deployment
#
# 使用方法 / Usage:
#   # 独立模式 (容器自己连接行情) / Independent mode
#   STRATEGY_NAME=SMA docker compose -f docker-compose.single-strategy.yml up -d
#
#   # 共享行情模式 (推荐) / Shared market data mode (recommended)
#   USE_SHARED_MARKET_DATA=true STRATEGY_NAME=SMA docker compose -f docker-compose.single-strategy.yml --profile market-data up -d
#
#   # 如果行情服务已在其他地方运行 / If market data service is already running elsewhere
#   USE_SHARED_MARKET_DATA=true STRATEGY_NAME=SMA docker compose -f docker-compose.single-strategy.yml up -d
# =============================================================================

services:
  # ===========================================================================
  # 共享行情服务 (可选) / Shared Market Data Service (Optional)
  # 使用 --profile market-data 启动此服务
  # Use --profile market-data to start this service
  # ===========================================================================
  market-data-service:
    image: quant-trading-system:latest
    container_name: quant-market-data
    restart: unless-stopped
    network_mode: host
    profiles:
      - market-data
    volumes:
      - ./logs/market-data:/app/logs
      - ./.env:/app/.env:ro
      - ./.keys.enc:/app/.keys.enc:ro
    environment:
      NODE_ENV: production
      LOG_LEVEL: info
      TZ: Asia/Shanghai
      MASTER_KEY: ${MASTER_KEY}
      REDIS_HOST: 127.0.0.1
      REDIS_PORT: 6379
      REDIS_PASSWORD: ${REDIS_PASSWORD:-}
      # 行情服务配置 / Market data service configuration
      # 留空则自动检测已配置API密钥的交易所 / Leave empty to auto-detect exchanges with configured API keys
      MARKET_DATA_EXCHANGES: ${MARKET_DATA_EXCHANGES:-}
      TRADING_TYPE: ${TRADING_TYPE:-futures}
      SUBSCRIBE_ALL: ${SUBSCRIBE_ALL:-true}
      # 如果指定交易对则只订阅指定的 / If symbols specified, only subscribe to those
      MARKET_DATA_SYMBOLS: ${MARKET_DATA_SYMBOLS:-}
    command: ["node", "src/services/market-data-service.js"]
    healthcheck:
      test: ["CMD-SHELL", "node -e \"const Redis = require('ioredis'); const r = new Redis({host:'127.0.0.1',password:process.env.REDIS_PASSWORD||undefined}); r.get('market:service:heartbeat').then(v => process.exit(v ? 0 : 1)).catch(() => process.exit(1))\""]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 30s
    deploy:
      resources:
        limits:
          memory: 2G
          cpus: '2.0'
    logging:
      driver: json-file
      options:
        max-size: "200m"
        max-file: "10"
    labels:
      - "quant.role=market-data"
      - "quant.shared=true"

  # ===========================================================================
  # 共享通知服务 (可选) / Shared Notification Service (Optional)
  # 使用 --profile notification 启动此服务
  # Use --profile notification to start this service
  # ===========================================================================
  notification-service:
    image: quant-trading-system:latest
    container_name: quant-notification
    restart: unless-stopped
    network_mode: host
    profiles:
      - notification
    volumes:
      - ./logs/notification:/app/logs
      - ./.env:/app/.env:ro
    environment:
      NODE_ENV: production
      LOG_LEVEL: info
      TZ: Asia/Shanghai
      MASTER_KEY: ${MASTER_KEY}
      REDIS_HOST: 127.0.0.1
      REDIS_PORT: 6379
      REDIS_PASSWORD: ${REDIS_PASSWORD:-}
      # Telegram 配置 / Telegram configuration
      TELEGRAM_BOT_TOKEN: ${TELEGRAM_BOT_TOKEN:-}
      TELEGRAM_CHAT_ID: ${TELEGRAM_CHAT_ID:-}
      TELEGRAM_ENABLED: ${TELEGRAM_ENABLED:-true}
      # 限流配置 / Rate limit configuration
      RATE_LIMIT_PER_SECOND: ${RATE_LIMIT_PER_SECOND:-1}
      RATE_LIMIT_PER_MINUTE: ${RATE_LIMIT_PER_MINUTE:-20}
      MAX_QUEUE_LENGTH: ${MAX_QUEUE_LENGTH:-100}
    command: ["node", "src/services/notification-service.js"]
    healthcheck:
      test: ["CMD-SHELL", "node -e \"const Redis = require('ioredis'); const r = new Redis({host:'127.0.0.1',password:process.env.REDIS_PASSWORD||undefined}); r.get('notification:service:heartbeat').then(v => process.exit(v ? 0 : 1)).catch(() => process.exit(1))\""]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 30s
    deploy:
      resources:
        limits:
          memory: 256M
          cpus: '0.25'
    logging:
      driver: json-file
      options:
        max-size: "50m"
        max-file: "5"
    labels:
      - "quant.role=notification"
      - "quant.shared=true"

  # ===========================================================================
  # 单策略实例 / Single Strategy Instance
  # ===========================================================================
  quant-single:
    image: quant-trading-system:latest
    container_name: quant-${STRATEGY_NAME:-SMA}
    restart: unless-stopped
    network_mode: host
    # 共享行情模式下等待行情服务就绪 / Wait for market data service in shared mode
    # 仅当使用 --profile market-data 启动时生效 / Only effective when using --profile market-data
    depends_on:
      market-data-service:
        condition: service_healthy
        required: false
    volumes:
      - ./logs/${STRATEGY_NAME:-SMA}:/app/logs
      - ./data/${STRATEGY_NAME:-SMA}:/app/data
      - ./config/strategies:/app/strategies:ro
      - ./.env:/app/.env:ro
    environment:
      NODE_ENV: production
      LOG_LEVEL: debug
      TZ: Asia/Shanghai
      # 加密密钥主密码 (从宿主机环境变量传入) / Master key for decryption (from host env)
      MASTER_KEY: ${MASTER_KEY}
      REDIS_HOST: 127.0.0.1
      REDIS_PORT: 6379
      CLICKHOUSE_HOST: 127.0.0.1
      CLICKHOUSE_PORT: 8123
      # 共享行情模式 / Shared market data mode
      USE_SHARED_MARKET_DATA: ${USE_SHARED_MARKET_DATA:-false}
      # 共享通知模式 / Shared notification mode
      USE_SHARED_NOTIFICATION: ${USE_SHARED_NOTIFICATION:-false}
      RUN_MODE: ${RUN_MODE:-shadow}
      INSTANCE_NAME: ${STRATEGY_NAME:-SMA}
      INSTANCE_ID: "1"
      # 服务名称 (用于 Telegram 通知显示) / Service name (for Telegram notifications)
      SERVICE_NAME: ${STRATEGY_NAME:-SMA}
      # =========================================================================
      # 策略配置 (根据需要修改) / Strategy Configuration (modify as needed)
      # =========================================================================
      # 单策略模式: 直接指定策略名 / Single strategy mode: specify strategy name directly
      STRATEGY_NAME: ${STRATEGY_NAME:-SMA}
      # 或使用组合模式: WeightedCombo + COMBO_STRATEGIES
      # Or use combo mode: WeightedCombo + COMBO_STRATEGIES
      # STRATEGY_NAME: WeightedCombo
      # COMBO_STRATEGIES: "SMA,RSI,MACD"
      # =========================================================================
      # 交易对配置 / Trading Pairs Configuration
      # =========================================================================
      DEFAULT_SYMBOLS: ${DEFAULT_SYMBOLS:-BTC/USDT,ETH/USDT}
      DEFAULT_TIMEFRAME: ${DEFAULT_TIMEFRAME:-1h}
      # =========================================================================
      # 风控配置 / Risk Control Configuration
      # =========================================================================
      MAX_POSITIONS: ${MAX_POSITIONS:-4}
      MAX_POSITION_SIZE: ${MAX_POSITION_SIZE:-0.25}
      MAX_LEVERAGE: ${MAX_LEVERAGE:-2}
      MAX_DAILY_LOSS: ${MAX_DAILY_LOSS:-0.03}
      # =========================================================================
      # 端口配置 / Port Configuration (使用环境变量避免冲突)
      # =========================================================================
      PORT: "${PORT:-3000}"
      METRICS_PORT: "${METRICS_PORT:-9100}"
      WS_PORT: "${WS_PORT:-8000}"
      STRATEGY_CONFIG: "/app/strategies/single.json"
    command: ["node", "src/main.js", "${RUN_MODE:-shadow}", "--strategy", "${STRATEGY_NAME:-SMA}"]
    healthcheck:
      test: ["CMD", "pgrep", "-f", "node"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    deploy:
      resources:
        limits:
          memory: 1G
          cpus: '1.0'
    logging:
      driver: json-file
      options:
        max-size: "100m"
        max-file: "5"
    labels:
      - "quant.role=single"
      - "quant.frequency=medium"
