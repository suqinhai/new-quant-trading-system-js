#!/bin/bash

# 更新软件包列表
sudo apt update

# 安装 Git
sudo apt install git -y

# 安装 Node.js 20+
curl -fsSL https://deb.nodesource.com/setup_20.x | sudo -E bash -
sudo apt-get install -y nodejs

# 验证安装（可选）
node --version  # 应该 >= 20.0.0
npm --version   # 应该 >= 8.0.0

# 安装 PM2 进程管理器
sudo npm install -g pm2

# 安装 Redis（可选，用于缓存）
sudo apt-get install redis-server -y

# 设置 Redis 密码
echo "requirepass 123456" | sudo tee -a /etc/redis/redis.conf

# 重启 Redis 服务
sudo systemctl restart redis-server

# 安装 ClickHouse（用于交易数据归档和分析）
# 首先安装依赖
sudo apt-get install -y apt-transport-https ca-certificates curl gnupg

# 添加 ClickHouse 密钥和仓库
curl -fsSL 'https://packages.clickhouse.com/rpm/lts/repodata/repomd.xml.key' | sudo gpg --dearmor -o /usr/share/keyrings/clickhouse-keyring.gpg
echo "deb [signed-by=/usr/share/keyrings/clickhouse-keyring.gpg] https://packages.clickhouse.com/deb stable main" | sudo tee /etc/apt/sources.list.d/clickhouse.list

# 更新软件包列表
sudo apt-get update

# 预设 ClickHouse 密码以自动化安装（默认密码 123456）
# 注意：ClickHouse deb 安装使用 debconf 设置密码
echo "clickhouse-server clickhouse-server/password password 123456" | sudo debconf-set-selections
echo "clickhouse-server clickhouse-server/password-confirm password 123456" | sudo debconf-set-selections

# 安装 ClickHouse
sudo apt-get install -y clickhouse-server clickhouse-client

# 启动服务
sudo systemctl enable clickhouse-server
sudo systemctl start clickhouse-server

# 验证安装（可选）
clickhouse-client --query "SELECT version()"

# 设置解密 MASTER_KEY（针对当前用户）
echo "export MASTER_KEY='123456'" >> ~/.bashrc
source ~/.bashrc
echo "$MASTER_KEY"