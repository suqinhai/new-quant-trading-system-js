# =============================================================================
# Docker Compose - 多策略部署配置 (使用宿主机Redis/ClickHouse)
# Multi-Strategy Deployment Configuration (Using Host Redis/ClickHouse)
#
# 21个策略拆分为5个Docker实例
# 21 strategies split into 5 Docker instances
#
# 使用方法 / Usage:
#   # 独立模式 (每个容器自己连接行情) / Independent mode
#   docker compose -f docker-compose.multi-strategy.yml up -d
#
#   # 共享行情模式 (推荐) / Shared market data mode (recommended)
#   USE_SHARED_MARKET_DATA=true docker compose -f docker-compose.multi-strategy.yml --profile market-data up -d
#
#   # 如果行情服务已在其他地方运行 / If market data service is already running elsewhere
#   USE_SHARED_MARKET_DATA=true docker compose -f docker-compose.multi-strategy.yml up -d
# =============================================================================

services:
  # ===========================================================================
  # 共享行情服务 (可选) / Shared Market Data Service (Optional)
  # 使用 --profile market-data 启动此服务
  # Use --profile market-data to start this service
  # ===========================================================================
  market-data-service:
    image: quant-trading-system:latest
    container_name: quant-market-data
    restart: unless-stopped
    network_mode: host
    profiles:
      - market-data
    volumes:
      - ./logs/market-data:/app/logs
      - ./.env:/app/.env:ro
    environment:
      NODE_ENV: production
      LOG_LEVEL: info
      TZ: Asia/Shanghai
      MASTER_KEY: ${MASTER_KEY}
      REDIS_HOST: 127.0.0.1
      REDIS_PORT: 6379
      # 行情服务配置 / Market data service configuration
      MARKET_DATA_EXCHANGES: ${MARKET_DATA_EXCHANGES:-binance,okx,bybit}
      TRADING_TYPE: ${TRADING_TYPE:-futures}
      SUBSCRIBE_ALL: ${SUBSCRIBE_ALL:-true}
      # 如果指定交易对则只订阅指定的 / If symbols specified, only subscribe to those
      MARKET_DATA_SYMBOLS: ${MARKET_DATA_SYMBOLS:-}
    command: ["node", "src/services/market-data-service.js"]
    healthcheck:
      test: ["CMD-SHELL", "node -e \"const Redis = require('ioredis'); const r = new Redis({host:'127.0.0.1'}); r.get('market:service:heartbeat').then(v => process.exit(v ? 0 : 1)).catch(() => process.exit(1))\""]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 30s
    deploy:
      resources:
        limits:
          memory: 2G
          cpus: '2.0'
    logging:
      driver: json-file
      options:
        max-size: "200m"
        max-file: "10"
    labels:
      - "quant.role=market-data"
      - "quant.shared=true"

  # ===========================================================================
  # 共享通知服务 (可选) / Shared Notification Service (Optional)
  # 使用 --profile notification 启动此服务
  # Use --profile notification to start this service
  # ===========================================================================
  notification-service:
    image: quant-trading-system:latest
    container_name: quant-notification
    restart: unless-stopped
    network_mode: host
    profiles:
      - notification
    volumes:
      - ./logs/notification:/app/logs
      - ./.env:/app/.env:ro
    environment:
      NODE_ENV: production
      LOG_LEVEL: info
      TZ: Asia/Shanghai
      MASTER_KEY: ${MASTER_KEY}
      REDIS_HOST: 127.0.0.1
      REDIS_PORT: 6379
      # Telegram 配置 / Telegram configuration
      TELEGRAM_BOT_TOKEN: ${TELEGRAM_BOT_TOKEN:-}
      TELEGRAM_CHAT_ID: ${TELEGRAM_CHAT_ID:-}
      TELEGRAM_ENABLED: ${TELEGRAM_ENABLED:-true}
      # 限流配置 / Rate limit configuration
      RATE_LIMIT_PER_SECOND: ${RATE_LIMIT_PER_SECOND:-1}
      RATE_LIMIT_PER_MINUTE: ${RATE_LIMIT_PER_MINUTE:-20}
      MAX_QUEUE_LENGTH: ${MAX_QUEUE_LENGTH:-100}
    command: ["node", "src/services/notification-service.js"]
    healthcheck:
      test: ["CMD-SHELL", "node -e \"const Redis = require('ioredis'); const r = new Redis({host:'127.0.0.1'}); r.get('notification:service:heartbeat').then(v => process.exit(v ? 0 : 1)).catch(() => process.exit(1))\""]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 30s
    deploy:
      resources:
        limits:
          memory: 256M
          cpus: '0.25'
    logging:
      driver: json-file
      options:
        max-size: "50m"
        max-file: "5"
    labels:
      - "quant.role=notification"
      - "quant.shared=true"

  # ===========================================================================
  # Docker #1: 趋势核心 (低频 / 骨架)
  # ===========================================================================
  quant-trend-core:
    image: quant-trading-system:latest
    container_name: quant-trend-core
    restart: unless-stopped
    network_mode: host
    volumes:
      - ./logs/trend-core:/app/logs
      - ./data/trend-core:/app/data
      - ./config/strategies:/app/strategies:ro
      - ./.env:/app/.env:ro
    environment:
      NODE_ENV: production
      LOG_LEVEL: info
      TZ: Asia/Shanghai
      # 加密密钥主密码 (从宿主机环境变量传入) / Master key for decryption (from host env)
      MASTER_KEY: ${MASTER_KEY}
      REDIS_HOST: 127.0.0.1
      REDIS_PORT: 6379
      CLICKHOUSE_HOST: 127.0.0.1
      CLICKHOUSE_PORT: 8123
      # 共享行情模式 / Shared market data mode
      USE_SHARED_MARKET_DATA: ${USE_SHARED_MARKET_DATA:-false}
      # 共享通知模式 / Shared notification mode
      USE_SHARED_NOTIFICATION: ${USE_SHARED_NOTIFICATION:-false}
      RUN_MODE: ${RUN_MODE:-shadow}
      INSTANCE_NAME: trend-core
      INSTANCE_ID: "1"
      SERVICE_NAME: trend-core
      STRATEGY_NAME: WeightedCombo
      COMBO_STRATEGIES: "SMA,MultiTimeframe,RegimeSwitching,VolatilityRegime"
      DEFAULT_SYMBOLS: "BTC/USDT:USDT,ETH/USDT:USDT"
      DEFAULT_TIMEFRAME: "4h"
      MAX_POSITIONS: "4"
      MAX_POSITION_SIZE: "0.25"
      MAX_LEVERAGE: "2"
      MAX_DAILY_LOSS: "0.03"
      # host模式下需要指定不同端口 (多策略专用端口段: PORT 2000+, METRICS 4000+, WS 6000+)
      PORT: "2001"
      METRICS_PORT: "4001"
      WS_PORT: "6001"
      STRATEGY_CONFIG: "/app/strategies/trend-core.json"
    command: ["node", "src/main.js", "${RUN_MODE:-shadow}", "--strategy", "WeightedCombo"]
    healthcheck:
      test: ["CMD", "pgrep", "-f", "node"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    deploy:
      resources:
        limits:
          memory: 1G
          cpus: '1.0'
    logging:
      driver: json-file
      options:
        max-size: "100m"
        max-file: "5"
    labels:
      - "quant.role=trend-core"
      - "quant.frequency=low"

  # ===========================================================================
  # Docker #2: 技术指标中频 (Alpha)
  # ===========================================================================
  quant-tech-alpha:
    image: quant-trading-system:latest
    container_name: quant-tech-alpha
    restart: unless-stopped
    network_mode: host
    volumes:
      - ./logs/tech-alpha:/app/logs
      - ./data/tech-alpha:/app/data
      - ./config/strategies:/app/strategies:ro
      - ./.env:/app/.env:ro
    environment:
      NODE_ENV: production
      LOG_LEVEL: info
      TZ: Asia/Shanghai
      # 加密密钥主密码 (从宿主机环境变量传入) / Master key for decryption (from host env)
      MASTER_KEY: ${MASTER_KEY}
      REDIS_HOST: 127.0.0.1
      REDIS_PORT: 6379
      CLICKHOUSE_HOST: 127.0.0.1
      CLICKHOUSE_PORT: 8123
      # 共享行情模式 / Shared market data mode
      USE_SHARED_MARKET_DATA: ${USE_SHARED_MARKET_DATA:-false}
      # 共享通知模式 / Shared notification mode
      USE_SHARED_NOTIFICATION: ${USE_SHARED_NOTIFICATION:-false}
      RUN_MODE: ${RUN_MODE:-shadow}
      INSTANCE_NAME: tech-alpha
      INSTANCE_ID: "2"
      SERVICE_NAME: tech-alpha
      STRATEGY_NAME: WeightedCombo
      COMBO_STRATEGIES: "RSI,MACD,BollingerBands,ATRBreakout,BollingerWidth,Adaptive"
      DEFAULT_SYMBOLS: "BTC/USDT:USDT,ETH/USDT:USDT,BNB/USDT:USDT,SOL/USDT:USDT"
      DEFAULT_TIMEFRAME: "1h"
      MAX_POSITIONS: "6"
      MAX_POSITION_SIZE: "0.15"
      MAX_LEVERAGE: "3"
      MAX_DAILY_LOSS: "0.05"
      PORT: "2002"
      METRICS_PORT: "4002"
      WS_PORT: "6002"
      STRATEGY_CONFIG: "/app/strategies/tech-alpha.json"
    command: ["node", "src/main.js", "${RUN_MODE:-shadow}", "--strategy", "WeightedCombo"]
    healthcheck:
      test: ["CMD", "pgrep", "-f", "node"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    deploy:
      resources:
        limits:
          memory: 1.5G
          cpus: '1.5'
    logging:
      driver: json-file
      options:
        max-size: "100m"
        max-file: "5"
    labels:
      - "quant.role=tech-alpha"
      - "quant.frequency=medium"

  # ===========================================================================
  # Docker #3: 横截面 / 因子组合
  # ===========================================================================
  quant-cross-factor:
    image: quant-trading-system:latest
    container_name: quant-cross-factor
    restart: unless-stopped
    network_mode: host
    volumes:
      - ./logs/cross-factor:/app/logs
      - ./data/cross-factor:/app/data
      - ./config/strategies:/app/strategies:ro
      - ./.env:/app/.env:ro
    environment:
      NODE_ENV: production
      LOG_LEVEL: info
      TZ: Asia/Shanghai
      # 加密密钥主密码 (从宿主机环境变量传入) / Master key for decryption (from host env)
      MASTER_KEY: ${MASTER_KEY}
      REDIS_HOST: 127.0.0.1
      REDIS_PORT: 6379
      CLICKHOUSE_HOST: 127.0.0.1
      CLICKHOUSE_PORT: 8123
      # 共享行情模式 / Shared market data mode
      USE_SHARED_MARKET_DATA: ${USE_SHARED_MARKET_DATA:-false}
      # 共享通知模式 / Shared notification mode
      USE_SHARED_NOTIFICATION: ${USE_SHARED_NOTIFICATION:-false}
      RUN_MODE: ${RUN_MODE:-shadow}
      INSTANCE_NAME: cross-factor
      INSTANCE_ID: "3"
      SERVICE_NAME: cross-factor
      STRATEGY_NAME: WeightedCombo
      COMBO_STRATEGIES: "Rotation,MomentumRank,CrossSectional"
      DEFAULT_SYMBOLS: "BTC/USDT:USDT,ETH/USDT:USDT,BNB/USDT:USDT,SOL/USDT:USDT,XRP/USDT:USDT,DOGE/USDT:USDT,ADA/USDT:USDT,AVAX/USDT:USDT,DOT/USDT:USDT,LINK/USDT:USDT"
      DEFAULT_TIMEFRAME: "4h"
      CROSS_SECTIONAL_TOP_N: "3"
      CROSS_SECTIONAL_BOTTOM_N: "3"
      ROTATION_LOOKBACK: "168"
      MAX_POSITIONS: "10"
      MAX_POSITION_SIZE: "0.10"
      MAX_LEVERAGE: "2"
      MAX_DAILY_LOSS: "0.04"
      PORT: "2003"
      METRICS_PORT: "4003"
      WS_PORT: "6003"
      STRATEGY_CONFIG: "/app/strategies/cross-factor.json"
    command: ["node", "src/main.js", "${RUN_MODE:-shadow}", "--strategy", "WeightedCombo"]
    healthcheck:
      test: ["CMD", "pgrep", "-f", "node"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    deploy:
      resources:
        limits:
          memory: 1.5G
          cpus: '1.5'
    logging:
      driver: json-file
      options:
        max-size: "100m"
        max-file: "5"
    labels:
      - "quant.role=cross-factor"
      - "quant.frequency=medium"

  # ===========================================================================
  # Docker #4: 事件 / 风控 / 特殊信号
  # ===========================================================================
  quant-event-risk:
    image: quant-trading-system:latest
    container_name: quant-event-risk
    restart: unless-stopped
    network_mode: host
    volumes:
      - ./logs/event-risk:/app/logs
      - ./data/event-risk:/app/data
      - ./config/strategies:/app/strategies:ro
      - ./.env:/app/.env:ro
    environment:
      NODE_ENV: production
      LOG_LEVEL: info
      TZ: Asia/Shanghai
      # 加密密钥主密码 (从宿主机环境变量传入) / Master key for decryption (from host env)
      MASTER_KEY: ${MASTER_KEY}
      REDIS_HOST: 127.0.0.1
      REDIS_PORT: 6379
      CLICKHOUSE_HOST: 127.0.0.1
      CLICKHOUSE_PORT: 8123
      # 共享行情模式 / Shared market data mode
      USE_SHARED_MARKET_DATA: ${USE_SHARED_MARKET_DATA:-false}
      # 共享通知模式 / Shared notification mode
      USE_SHARED_NOTIFICATION: ${USE_SHARED_NOTIFICATION:-false}
      RUN_MODE: ${RUN_MODE:-shadow}
      INSTANCE_NAME: event-risk
      INSTANCE_ID: "4"
      SERVICE_NAME: event-risk
      STRATEGY_NAME: WeightedCombo
      COMBO_STRATEGIES: "FundingRateExtreme,RiskDriven"
      DEFAULT_SYMBOLS: "BTC/USDT:USDT,ETH/USDT:USDT,BNB/USDT:USDT,SOL/USDT:USDT"
      DEFAULT_TIMEFRAME: "1h"
      FUNDING_EXTREME_THRESHOLD: "0.001"
      FUNDING_LOOKBACK_HOURS: "24"
      MAX_POSITIONS: "4"
      MAX_POSITION_SIZE: "0.15"
      MAX_LEVERAGE: "2"
      MAX_DAILY_LOSS: "0.02"
      MAX_DRAWDOWN: "0.05"
      PORT: "2004"
      METRICS_PORT: "4004"
      WS_PORT: "6004"
      STRATEGY_CONFIG: "/app/strategies/event-risk.json"
    command: ["node", "src/main.js", "${RUN_MODE:-shadow}", "--strategy", "WeightedCombo"]
    healthcheck:
      test: ["CMD", "pgrep", "-f", "node"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    deploy:
      resources:
        limits:
          memory: 768M
          cpus: '0.75'
    logging:
      driver: json-file
      options:
        max-size: "100m"
        max-file: "5"
    labels:
      - "quant.role=event-risk"
      - "quant.frequency=low"

  # ===========================================================================
  # Docker #5: 高频 / 套利 (独立世界)
  # ⚠️ 警告: 此实例需要独立的API Key和子账户!
  # ===========================================================================
  quant-hf-arbitrage:
    image: quant-trading-system:latest
    container_name: quant-hf-arbitrage
    restart: unless-stopped
    network_mode: host
    volumes:
      - ./logs/hf-arbitrage:/app/logs
      - ./data/hf-arbitrage:/app/data
      - ./config/strategies:/app/strategies:ro
      - ./.env:/app/.env:ro
    environment:
      NODE_ENV: production
      LOG_LEVEL: info
      TZ: Asia/Shanghai
      # 加密密钥主密码 (从宿主机环境变量传入) / Master key for decryption (from host env)
      MASTER_KEY: ${MASTER_KEY}
      REDIS_HOST: 127.0.0.1
      REDIS_PORT: 6379
      CLICKHOUSE_HOST: 127.0.0.1
      CLICKHOUSE_PORT: 8123
      # 共享行情模式 / Shared market data mode
      USE_SHARED_MARKET_DATA: ${USE_SHARED_MARKET_DATA:-false}
      # 共享通知模式 / Shared notification mode
      USE_SHARED_NOTIFICATION: ${USE_SHARED_NOTIFICATION:-false}
      RUN_MODE: ${RUN_MODE:-shadow}
      INSTANCE_NAME: hf-arbitrage
      INSTANCE_ID: "5"
      SERVICE_NAME: hf-arbitrage
      STRATEGY_NAME: WeightedCombo
      COMBO_STRATEGIES: "Grid,OrderFlow,StatisticalArbitrage,CrossExchangeSpread,FundingArb"
      DEFAULT_SYMBOLS: "BTC/USDT:USDT,ETH/USDT:USDT"
      DEFAULT_TIMEFRAME: "1m"
      # 网格策略配置
      GRID_LEVELS: "20"
      GRID_SPACING: "0.005"
      # 套利配置
      ARB_MIN_SPREAD: "0.001"
      ARB_MAX_SLIPPAGE: "0.0005"
      STAT_ARB_ZSCORE_ENTRY: "2.0"
      STAT_ARB_ZSCORE_EXIT: "0.5"
      # 风控配置
      MAX_POSITIONS: "20"
      MAX_POSITION_SIZE: "0.05"
      MAX_LEVERAGE: "5"
      MAX_DAILY_LOSS: "0.03"
      # 性能优化
      WS_PING_INTERVAL: "5000"
      ORDER_TIMEOUT: "3000"
      ENABLE_ORDER_BOOK_CACHE: "true"
      PORT: "2005"
      METRICS_PORT: "4005"
      WS_PORT: "6005"
      STRATEGY_CONFIG: "/app/strategies/hf-arbitrage.json"
    command: ["node", "src/main.js", "${RUN_MODE:-shadow}", "--strategy", "WeightedCombo"]
    healthcheck:
      test: ["CMD", "pgrep", "-f", "node"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    deploy:
      resources:
        limits:
          memory: 2G
          cpus: '2.0'
    logging:
      driver: json-file
      options:
        max-size: "200m"
        max-file: "10"
    labels:
      - "quant.role=hf-arbitrage"
      - "quant.frequency=high"
      - "quant.isolated=true"
