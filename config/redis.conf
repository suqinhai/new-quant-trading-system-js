# =============================================================================
# Redis Configuration for Quant Trading System
# Redis 量化交易系统配置文件
# =============================================================================

# -----------------------------------------------------------------------------
# NETWORK / 网络配置
# -----------------------------------------------------------------------------

# 绑定地址 / Bind address
bind 127.0.0.1

# 端口 / Port
port 6379

# 保护模式 / Protected mode
protected-mode yes

# TCP 连接队列长度 / TCP backlog
tcp-backlog 511

# 客户端空闲超时 (0 表示禁用) / Client idle timeout (0 to disable)
timeout 0

# TCP keepalive / TCP 保活
tcp-keepalive 300

# -----------------------------------------------------------------------------
# GENERAL / 通用配置
# -----------------------------------------------------------------------------

# 以守护进程运行 / Run as daemon
daemonize no

# PID 文件 / PID file
pidfile /var/run/redis/redis-server.pid

# 日志级别 / Log level (debug, verbose, notice, warning)
loglevel notice

# 日志文件 / Log file
logfile ""

# 数据库数量 / Number of databases
databases 16

# 启动时显示 logo / Show logo on startup
always-show-logo no

# -----------------------------------------------------------------------------
# SNAPSHOTTING (RDB) / RDB 快照持久化
# DB-014: 配置 Redis RDB 定期快照
# -----------------------------------------------------------------------------

# RDB 快照触发条件 / RDB snapshot triggers
# save <seconds> <changes>
# 900秒(15分钟)内有1次修改则保存
save 900 1
# 300秒(5分钟)内有10次修改则保存
save 300 10
# 60秒(1分钟)内有10000次修改则保存
save 60 10000

# RDB 保存失败时停止写入 / Stop writes on RDB save error
stop-writes-on-bgsave-error yes

# RDB 压缩 / RDB compression
rdbcompression yes

# RDB 校验 / RDB checksum
rdbchecksum yes

# RDB 文件名 / RDB filename
dbfilename dump.rdb

# RDB 文件保存目录 / RDB save directory
dir /data/redis

# 删除 RDB 中的同步复制标记 / Remove replication info from RDB
rdb-del-sync-files no

# -----------------------------------------------------------------------------
# APPEND ONLY MODE (AOF) / AOF 追加持久化
# DB-013: 配置 Redis AOF 持久化
# -----------------------------------------------------------------------------

# 启用 AOF / Enable AOF
appendonly yes

# AOF 文件名 / AOF filename
appendfilename "appendonly.aof"

# AOF 目录名 / AOF directory name
appenddirname "appendonlydir"

# AOF 同步策略 / AOF fsync policy
# always: 每次写入都同步 (最安全, 最慢)
# everysec: 每秒同步一次 (推荐, 平衡安全和性能)
# no: 由操作系统决定 (最快, 最不安全)
appendfsync everysec

# 重写 AOF 时是否暂停 fsync / No fsync during AOF rewrite
no-appendfsync-on-rewrite no

# AOF 重写触发条件 / AOF rewrite triggers
# 当 AOF 文件大小超过上次重写后大小的 100% 时触发重写
auto-aof-rewrite-percentage 100
# AOF 文件最小大小 (64MB)，小于此大小不触发重写
auto-aof-rewrite-min-size 64mb

# AOF 加载时遇到截断文件是否继续 / Continue on truncated AOF
aof-load-truncated yes

# 使用 RDB 前缀加速 AOF 重写 / Use RDB preamble in AOF
aof-use-rdb-preamble yes

# AOF 时间戳 / AOF timestamp
aof-timestamp-enabled no

# -----------------------------------------------------------------------------
# MEMORY MANAGEMENT / 内存管理
# -----------------------------------------------------------------------------

# 最大内存限制 / Max memory limit
# 根据系统配置调整，例如 2GB
maxmemory 2gb

# 内存淘汰策略 / Eviction policy
# volatile-lru: 对设置了过期时间的键使用 LRU 淘汰
# allkeys-lru: 对所有键使用 LRU 淘汰
# volatile-lfu: 对设置了过期时间的键使用 LFU 淘汰
# allkeys-lfu: 对所有键使用 LFU 淘汰
# volatile-random: 随机淘汰设置了过期时间的键
# allkeys-random: 随机淘汰所有键
# volatile-ttl: 淘汰 TTL 最短的键
# noeviction: 不淘汰，内存满时拒绝写入
maxmemory-policy volatile-lru

# LRU/LFU 采样数 / LRU/LFU sample size
maxmemory-samples 5

# -----------------------------------------------------------------------------
# LAZY FREEING / 异步删除
# -----------------------------------------------------------------------------

# 异步删除过期键 / Async eviction
lazyfree-lazy-eviction no

# 异步删除过期键 / Async expire
lazyfree-lazy-expire no

# 异步删除服务端键 / Async server-del
lazyfree-lazy-server-del no

# 副本异步删除 / Async replica delete
replica-lazy-flush no

# 异步删除用户键 / Async user delete
lazyfree-lazy-user-del no

# 异步释放用户刷新 / Async user flush
lazyfree-lazy-user-flush no

# -----------------------------------------------------------------------------
# SECURITY / 安全配置
# -----------------------------------------------------------------------------

# 密码认证 (生产环境必须设置) / Password (required in production)
# requirepass your_strong_password_here

# 重命名危险命令 / Rename dangerous commands
# rename-command FLUSHALL ""
# rename-command FLUSHDB ""
# rename-command CONFIG ""
# rename-command DEBUG ""

# -----------------------------------------------------------------------------
# CLIENTS / 客户端配置
# -----------------------------------------------------------------------------

# 最大客户端连接数 / Max clients
maxclients 10000

# -----------------------------------------------------------------------------
# SLOW LOG / 慢查询日志
# -----------------------------------------------------------------------------

# 慢查询时间阈值 (微秒) / Slow log time threshold (microseconds)
slowlog-log-slower-than 10000

# 慢查询日志最大长度 / Slow log max length
slowlog-max-len 128

# -----------------------------------------------------------------------------
# ADVANCED CONFIG / 高级配置
# -----------------------------------------------------------------------------

# Hash 编码优化阈值 / Hash encoding optimization
hash-max-listpack-entries 512
hash-max-listpack-value 64

# List 编码优化阈值 / List encoding optimization
list-max-listpack-size -2

# Set 编码优化阈值 / Set encoding optimization
set-max-intset-entries 512
set-max-listpack-entries 128
set-max-listpack-value 64

# Sorted Set 编码优化阈值 / Sorted Set encoding optimization
zset-max-listpack-entries 128
zset-max-listpack-value 64

# 主动重哈希 / Active rehashing
activerehashing yes

# 客户端输出缓冲区限制 / Client output buffer limits
client-output-buffer-limit normal 0 0 0
client-output-buffer-limit replica 256mb 64mb 60
client-output-buffer-limit pubsub 32mb 8mb 60

# 后台任务执行频率 / Background tasks frequency
hz 10

# 动态 hz / Dynamic hz
dynamic-hz yes

# AOF 重写增量同步 / AOF rewrite incremental fsync
aof-rewrite-incremental-fsync yes

# RDB 保存增量同步 / RDB save incremental fsync
rdb-save-incremental-fsync yes
